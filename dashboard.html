<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Equilibrio - v2.0 (Multi-profils, PAS, Bridges, Help)</title>
<style>
  :root{
    --tap:48px; --gap:12px; --pad:16px; --radius:16px;
    --bg:#0f1220; --card:#171a2b; --muted:#8a90a6; --text:#e9ecf5; --accent:#6ea8fe;
    --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --line:#27314f;
    --shadow:0 6px 24px rgba(0,0,0,.25);
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    background:var(--bg); color:var(--text);
    padding: env(safe-area-inset-top) 0 calc(56px + env(safe-area-inset-bottom));
    overflow-x:hidden;
  }
  .appbar{position:sticky; top:0; z-index:60; display:flex; align-items:center; justify-content:space-between;
    padding:12px var(--pad); background:#0f1220; gap:12px;}
  .title{font-weight:700; letter-spacing:.3px; white-space:nowrap}
  .profile{display:flex; align-items:center; gap:8px; background:#1f2338; border:1px solid var(--line);
    padding:4px 8px; border-radius:12px;}
  .profile select{background:transparent; color:var(--text); border:0; outline:none; font-size:14px}
  .profile .btn{min-height:auto}
  .kebab{width:40px; height:40px; display:grid; place-items:center; border-radius:12px;
    background:#1f2338; cursor:pointer; user-select:none}
  .sheet{position:fixed; right:8px; top:56px; background:#101426; border:1px solid var(--line);
    border-radius:16px; box-shadow:var(--shadow); width:320px; display:none}
  .sheet.open{display:block}
  .sheet h4{margin:12px 16px 4px; color:var(--muted); font-weight:600; font-size:12px}
  .sheet button{width:100%; text-align:left; background:transparent; color:var(--text); border:0; padding:12px 16px; cursor:pointer}
  .sheet button:hover{background:#1a1f35}

  .container{padding:0 var(--pad) var(--pad)}
  .cards{display:flex; flex-direction:column; gap:12px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:20px; padding:16px; box-shadow:var(--shadow)}
  .muted{color:var(--muted)}
  .row{display:flex; gap:8px; flex-wrap:wrap}
  .btn{min-height:var(--tap); padding:0 14px; border-radius:12px; border:1px solid var(--line);
    background:#1f2338; color:var(--text); cursor:pointer}
  .btn.primary{background:linear-gradient(180deg, #2f6bff, #2658d6); border:0}

  .kpis{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .kpi h2{margin:0; font-size:28px}

  .pie-wrap{display:grid; place-items:center}
  svg{max-width:420px; width:100%}
  .legend{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px}
  .legend-item{display:flex; align-items:center; gap:8px; font-size:14px}
  .dot{width:12px; height:12px; border-radius:3px; display:inline-block}

  .coach{border-left:6px solid var(--accent)}
  .coach.good{border-left-color:var(--good)}
  .coach.warn{border-left-color:var(--warn)}
  .coach.bad{border-left-color:var(--bad)}
  .coach .tag{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; margin-right:8px; background:#1f2338}

  input, select, textarea{width:100%; font-size:16px; min-height:var(--tap); padding:10px 12px;
    border-radius:12px; border:1px solid #2a3556; background:#0f1326; color:var(--text)}
  label{display:block; font-size:13px; color:var(--muted); margin:8px 2px}
  .grid{display:grid; gap:12px}
  .g2{grid-template-columns:1fr 1fr}

  .bottom-nav{position:fixed; z-index:65; left:0; right:0; bottom:0; background:#101426;
    border-top:1px solid var(--line); display:grid; grid-template-columns:repeat(4,1fr)}
  .tab{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
    padding:8px 4px; color:var(--muted); text-decoration:none; font-size:12px; user-select:none}
  .tab.active{color:#cfe0ff}

  .cta-sticky{position:sticky; bottom:0; padding:12px env(safe-area-inset-right) calc(12px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
    background:linear-gradient(0deg, rgba(15,18,32,1) 0%, rgba(15,18,32,0) 100%)}

  details{background:#101426; border:1px solid var(--line); border-radius:12px; padding:8px 12px}
  details>summary{cursor:pointer; list-style:none}
  details>summary::-webkit-details-marker{display:none}

  .modal{position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:100}
  .modal .panel{background:#0f1326; border:1px solid var(--line); border-radius:16px; width:min(720px, 92vw); max-height:85vh; overflow:auto; padding:16px; box-shadow:var(--shadow)}

  .hidden{display:none !important}

  @media (max-width:420px){
    .kpis{grid-template-columns:1fr}
    .legend{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="appbar">
    <div class="title">Equilibrio</div>
    <div class="profile">
      <label for="profileSelect" class="muted" style="font-size:12px">Profil</label>
      <select id="profileSelect" title="Choisir un profil"></select>
      <button id="btnAddProfile" class="btn" title="Nouveau profil">+</button>
      <button id="btnProfileMenu" class="btn" title="Options profil">⋯</button>
    </div>
    <div id="kebab" class="kebab" title="Menu">...</div>
  </div>

  <div id="sheet" class="sheet" role="dialog" aria-modal="true">
    <h4>ACTIONS</h4>
    <button id="btnExportCSV">Exporter CSV (profil courant)</button>
    <button id="btnExportJSON">Exporter JSON (profil courant)</button>
    <button id="btnImportJSON">Importer JSON dans ce profil</button>
    <button id="btnPrint">Imprimer / PDF</button>
    <h4>AIDE</h4>
    <button id="btnGuide">Guide pas à pas</button>
    <button id="btnAbout">À propos</button>
  </div>

  <div id="profileSheet" class="sheet" style="right:56px" role="dialog" aria-modal="true">
    <h4>PROFIL</h4>
    <button id="btnRenameProfile">Renommer</button>
    <button id="btnDuplicateProfile">Dupliquer</button>
    <button id="btnDeleteProfile">Supprimer</button>
  </div>

  <div id="helpModal" class="modal" aria-hidden="true">
    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <h3 style="margin:0">Guide pas à pas</h3>
        <button id="helpClose" class="btn">Fermer</button>
      </div>
      <ol style="line-height:1.6">
        <li><strong>Choisir ou créer un profil</strong> : En haut, sélectionne un profil (perso, couple, pro) ou crée-en un nouveau.</li>
        <li><strong>Renseigner tes revenus</strong> : Onglet <em>Plus</em>. Utilise le convertisseur Brut → Net (ajuste charges et PAS), puis <em>Utiliser comme Salaire net</em>.</li>
        <li><strong>Entrer tes dépenses</strong> : Toujours dans <em>Plus</em>, saisis les montants par catégories. Ajoute/supprime selon ta situation.</li>
        <li><strong>Vue</strong> : Dans <em>Vue</em>, vérifie le reste à vivre, le graphique et les conseils du mini‑coach.</li>
        <li><strong>Épargne</strong> : Dans <em>Épargne</em>, choisis un taux rapide (3%, 5%, 10%) ou un montant; projection instantanée.</li>
        <li><strong>Emprunt</strong> : Dans <em>Emprunt</em>, active <em>Utiliser mes revenus déclarés</em> pour importer automatiquement les revenus du profil.</li>
        <li><strong>Exporter/Importer</strong> : Menu ... (en haut à droite) pour sauvegarder en JSON/CSV ou recharger des données. Chaque profil est indépendant.</li>
        <li><strong>Astuce</strong> : Le mini‑coach signale les catégories au‑dessus de repères simples et propose une épargne mensuelle raisonnable.</li>
      </ol>
      <div class="muted" style="font-size:12px">Avertissement : Calculs simplifiés, à titre informatif.</div>
    </div>
  </div>

  <main class="container">
    <div id="coach" class="card coach">
      <div class="row" style="align-items:center; justify-content:space-between; gap:8px">
        <div>
          <span id="coachTag" class="tag">-</span>
          <strong id="coachTitle">Analyse en cours...</strong>
          <div id="coachMsg" class="muted" style="margin-top:4px">Renseigne tes revenus et dépenses pour voir des recommandations.</div>
        </div>
        <div class="row" style="gap:8px">
          <button id="btnCoachDetails" class="btn">Détails</button>
          <button id="goToPlus" class="btn">Compléter mes données</button>
        </div>
      </div>
    </div>

    <section id="view-dashboard" class="cards">
      <div class="card">
        <div class="kpis">
          <div class="kpi">
            <div class="muted">Reste à vivre (mois)</div>
            <h2 id="kpiReste">- €</h2>
            <div class="muted" id="kpiResteJour">- €/jour</div>
          </div>
          <div class="kpi">
            <div class="muted">Taux d'épargne potentiel</div>
            <h2 id="kpiTaux">- %</h2>
            <div class="muted" id="kpiVariation">Objectif mini : 5 %</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="pie-wrap">
          <svg id="pie" viewBox="0 0 200 200" class="pie" aria-label="Répartition des dépenses"></svg>
          <div class="legend" id="legend"></div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <button class="btn" id="btnRevenus">Gérer les revenus</button>
          <button class="btn" id="btnDepenses">Gérer les dépenses</button>
          <button class="btn primary" id="btnTryEpargne">Simuler épargne</button>
        </div>
      </div>

      <div id="coachDetails" class="card hidden">
        <h3 style="margin:0 0 8px">Recommandations</h3>
        <div id="coachList" class="grid"></div>
      </div>
    </section>

    <section id="view-epargne" class="cards hidden">
      <div class="card">
        <div class="row" style="flex-wrap:nowrap; overflow:auto">
          <button class="btn rate" data-rate="0">0%</button>
          <button class="btn rate" data-rate="3">3%</button>
          <button class="btn rate" data-rate="5">5%</button>
          <button class="btn rate" data-rate="10">10%</button>
          <button class="btn rate" data-rate="perso">Perso</button>
          <button class="btn" id="backToDash">Retour Vue</button>
        </div>
      </div>
      <div class="card">
        <label for="epargneMontant">Montant mensuel épargne suggéré (€)</label>
        <input id="epargneMontant" type="number" inputmode="decimal" placeholder="Ex: 150" />
        <div class="grid g2" style="margin-top:12px">
          <div>
            <label for="epargneDuree">Durée (mois)</label>
            <input id="epargneDuree" type="number" inputmode="numeric" value="12" />
          </div>
          <div>
            <label for="epargneRend">Rendement (%) optionnel</label>
            <input id="epargneRend" type="number" inputmode="decimal" placeholder="0 à 5" />
          </div>
        </div>
      </div>
      <div class="card">
        <div class="kpi">
          <div class="muted">Projection</div>
          <h2 id="epargneProjection">- €</h2>
          <div class="muted" id="epargneNote">Basé sur tes chiffres actuels.</div>
        </div>
      </div>
      <div class="cta-sticky">
        <button id="btnSaveEpargne" class="btn primary" style="width:100%">Enregistrer comme objectif</button>
      </div>
    </section>

    <section id="view-emprunt" class="cards hidden">
      <div class="card">
        <div class="row" style="align-items:center; justify-content:space-between">
          <div class="muted">Revenus nets mensuels utilisés ci‑dessous</div>
          <label style="display:flex; align-items:center; gap:8px">
            <input type="checkbox" id="syncEmprunt" checked>
            Utiliser mes revenus déclarés
          </label>
        </div>
        <div class="grid g2" style="margin-top:8px">
          <div>
            <label for="empRevenus">Revenus nets mensuels (€)</label>
            <input id="empRevenus" type="number" inputmode="decimal" />
          </div>
          <div>
            <label for="empCharges">Charges récurrentes (€)</label>
            <input id="empCharges" type="number" inputmode="decimal" />
          </div>
          <div>
            <label for="empTaux">Taux nominal annuel (%)</label>
            <input id="empTaux" type="number" inputmode="decimal" value="4" />
          </div>
          <div>
            <label for="empDuree">Durée (années)</label>
            <input id="empDuree" type="number" inputmode="numeric" value="20" />
          </div>
        </div>
      </div>
      <div class="card">
        <div class="kpis">
          <div class="kpi">
            <div class="muted">Mensualité maximale (35 %)</div>
            <h2 id="empMensu">- €</h2>
          </div>
          <div class="kpi">
            <div class="muted">Montant maximum</div>
            <h2 id="empMontant">- €</h2>
          </div>
        </div>
        <details style="margin-top:8px">
          <summary class="muted">Règle : 35 % d'endettement + stress test +1 pt</summary>
          <div style="margin-top:8px" class="muted">Mensualité max = 35 % des revenus nets − charges récurrentes. Le test à +1 pt de taux donne une marge de sécurité.</div>
        </details>
      </div>
    </section>

    <section id="view-plus" class="cards hidden">
      <div class="card">
        <h3 style="margin:0 0 8px">Revenus</h3>

        <div class="card" style="background:#12162a">
          <h4 style="margin:0 0 8px">Convertisseur Brut → Net (mensuel)</h4>
          <div class="grid g2">
            <div>
              <label for="brutVal">Salaire brut (€)</label>
              <input id="brutVal" type="number" inputmode="decimal" placeholder="Ex: 2500" />
            </div>
            <div>
              <label for="chargesPct">Taux de charges (%)</label>
              <input id="chargesPct" type="number" inputmode="decimal" value="23" />
            </div>
          </div>
          <div class="grid g2" style="margin-top:8px">
            <div>
              <label for="pasPct">PAS - prélèvement à la source (%)</label>
              <input id="pasPct" type="number" inputmode="decimal" value="0" />
            </div>
            <div>
              <label>Net avant / après PAS</label>
              <div class="row">
                <input id="netAvant" type="number" inputmode="decimal" disabled placeholder="Net avant PAS">
                <input id="netApres" type="number" inputmode="decimal" disabled placeholder="Net après PAS">
              </div>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="applyNetAvant">Utiliser Net avant PAS</button>
            <button class="btn" id="applyNetApres">Utiliser Net après PAS</button>
          </div>
          <div class="muted" style="margin-top:6px; font-size:12px">Approximation simple : Net avant PAS = Brut × (1 − charges%). Net après PAS = Net avant PAS × (1 − PAS%). Ajuste les % selon ta situation.</div>
        </div>

        <div class="grid g2" id="revenusList" style="margin-top:12px"></div>
        <div class="row" style="margin-top:8px"><button class="btn" id="addRevenu">+ Ajouter un revenu</button></div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Dépenses par catégories</h3>
        <div id="depensesList" class="grid"></div>
        <div class="row" style="margin-top:8px"><button class="btn" id="addCategorie">+ Ajouter une catégorie</button></div>
      </div>
      <div class="cta-sticky">
        <button id="btnSaveAll" class="btn primary" style="width:100%">Sauvegarder</button>
      </div>
    </section>
  </main>

  <nav class="bottom-nav" role="navigation" aria-label="Navigation principale">
    <a href="#" class="tab active" data-view="dashboard">Vue</a>
    <a href="#" class="tab" data-view="epargne">Épargne</a>
    <a href="#" class="tab" data-view="emprunt">Emprunt</a>
    <a href="#" class="tab" data-view="plus">Plus</a>
  </nav>

  <input type="file" id="fileImport" accept="application/json" class="hidden" />

<script>
(function(){
  /* ---------- Utils ---------- */
  function clone(obj){ try{ return structuredClone(obj); } catch(e){ return JSON.parse(JSON.stringify(obj)); } }
  var euro0 = new Intl.NumberFormat('fr-FR',{style:'currency', currency:'EUR', maximumFractionDigits:0});
  var euro2 = new Intl.NumberFormat('fr-FR',{style:'currency', currency:'EUR', maximumFractionDigits:2});
  function fmt0(n){ return isNaN(n)?'-': euro0.format(n); }
  function fmt2(n){ return isNaN(n)?'-': euro2.format(n); }
  function fmtPct(x){ return isNaN(x)?'-': (x*100).toFixed(1).replace('.',',')+' %'; }

  /* ---------- Profiles storage ---------- */
  var STORAGE_KEY = 'equilibrio_profiles_v2';
  var DEFAULT_PROFILE_ID = 'default';

  var defaultState = {
    meta:{ name:'Perso' },
    revenus:[{ label:'Salaire net', amount: 2000 }],
    depenses:[
      { label:'Logement', color:'#6ea8fe', amount: 700 },
      { label:'Transports', color:'#a78bfa', amount: 200 },
      { label:'Alimentation', color:'#34d399', amount: 300 },
      { label:'Sorties et Restos', color:'#f59e0b', amount: 120 },
      { label:'Abonnements', color:'#ef4444', amount: 60 },
      { label:'Shopping Loisirs', color:'#f472b6', amount: 90 }
    ],
    epargne:{ montant: 150, duree: 12, rendement: 0 },
    emprunt:{ useSync: true, revenus: 2000, charges: 300, taux: 4, duree: 20 }
  };

  function loadAll(){
    try{ var raw = localStorage.getItem(STORAGE_KEY); if(!raw) throw 0;
      var data = JSON.parse(raw);
      if(!data || !data.currentId || !data.profiles || !data.profiles[data.currentId]) throw 0;
      return data;
    }catch(_){
      var init = { currentId: DEFAULT_PROFILE_ID, profiles:{} };
      init.profiles[DEFAULT_PROFILE_ID] = clone(defaultState);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(init));
      return init;
    }
  }
  function saveAll(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(ALL)); }
  function getState(){ return ALL.profiles[ALL.currentId]; }
  function setState(s){ ALL.profiles[ALL.currentId] = s; saveAll(); }

  function addProfile(name){
    var id = 'p_'+Math.random().toString(36).slice(2,8);
    ALL.profiles[id] = clone(defaultState);
    ALL.profiles[id].meta.name = name||('Profil '+Object.keys(ALL.profiles).length);
    ALL.currentId = id; saveAll(); renderProfileSelect(); initRender();
  }
  function renameProfile(id, name){
    if(!ALL.profiles[id]) return;
    ALL.profiles[id].meta.name = name||ALL.profiles[id].meta.name; saveAll(); renderProfileSelect();
  }
  function duplicateProfile(id){
    var src = ALL.profiles[id]; if(!src) return;
    var id2 = 'p_'+Math.random().toString(36).slice(2,8);
    ALL.profiles[id2] = clone(src);
    ALL.profiles[id2].meta.name = src.meta.name+' (copie)';
    ALL.currentId = id2; saveAll(); renderProfileSelect(); initRender();
  }
  function deleteProfile(id){
    if(Object.keys(ALL.profiles).length<=1) { alert('Impossible : au moins un profil doit rester.'); return; }
    delete ALL.profiles[id];
    if(!ALL.profiles[ALL.currentId]){ ALL.currentId = Object.keys(ALL.profiles)[0]; }
    saveAll(); renderProfileSelect(); initRender();
  }

  function renderProfileSelect(){
    var sel = document.getElementById('profileSelect'); sel.innerHTML='';
    Object.keys(ALL.profiles).forEach(function(id){
      var opt = document.createElement('option');
      opt.value = id; opt.textContent = ALL.profiles[id].meta?.name || 'Profil';
      if(id===ALL.currentId) opt.selected = true;
      sel.appendChild(opt);
    });
  }

  /* ---------- App state ---------- */
  var ALL = loadAll();
  var state = getState();

  function totalRevenus(){ return state.revenus.reduce(function(a,b){ return a + (Number(b.amount)||0); }, 0); }
  function totalDepenses(){ return state.depenses.reduce(function(a,b){ return a + (Number(b.amount)||0); }, 0); }
  function computeReste(){ return Math.max(0, totalRevenus() - totalDepenses()); }
  function daysInMonth(){ var d=new Date(); return new Date(d.getFullYear(), d.getMonth()+1, 0).getDate(); }

  function coachEvaluate(){
    var revenus = totalRevenus();
    var dep = totalDepenses();
    var reste = revenus - dep;
    var resteJour = reste / daysInMonth();
    var tauxEpargne = revenus>0 ? Math.max(reste,0)/revenus : 0;

    var status='warn', title='Équilibre à surveiller';
    if(resteJour < 10 || tauxEpargne < 0.05 || reste<0){ status='bad'; title='Reste serré'; }
    if(resteJour > 20 && tauxEpargne >= 0.10){ status='good'; title='Bon cap'; }

    var reps = { 'Logement': 0.35, 'Transports': 0.15, 'Alimentation': 0.15, 'Sorties et Restos': 0.08, 'Abonnements': 0.03, 'Shopping Loisirs': 0.10 };
    var tips=[];
    state.depenses.forEach(function(d){
      var val=Number(d.amount)||0; if(val<=0||revenus<=0) return;
      var rep = reps[d.label]; if(rep==null) return;
      var part = val/revenus; if(part > rep + 0.02){
        var potential = Math.max(0, val - rep*revenus);
        tips.push('Alerte : '+d.label+' un peu élevé ('+(part*100).toFixed(1)+'% vs repère '+(rep*100).toFixed(0)+'%). Ramener à '+Math.round(rep*100)+'% libère '+fmt0(potential)+'/mois ('+fmt0(potential*12)+'/an).');
      }
    });
    var sugg = Math.round( (Math.min(0.05*revenus, 0.30*Math.max(reste,0))) / 10) * 10;
    if(sugg>0){ tips.unshift('Suggestion épargne : '+fmt0(sugg)+'/mois → '+fmt0(sugg*12)+' sur 12 mois.'); }
    return {status:status, title:title, reste:reste, resteJour:resteJour, tauxEpargne:tauxEpargne, tips:tips};
  }

  function renderCoach(){
    var c = coachEvaluate();
    var box = document.getElementById('coach');
    var tag = document.getElementById('coachTag');
    var title = document.getElementById('coachTitle');
    var msg = document.getElementById('coachMsg');
    box.classList.remove('good','warn','bad');
    box.classList.add(c.status==='good'?'good': c.status==='bad'?'bad':'warn');
    tag.textContent = c.status==='good'?'VERT': c.status==='bad'?'ROUGE':'ORANGE';
    title.textContent = c.title;
    msg.textContent = 'Reste : '+fmt0(c.reste)+' • '+fmt2(c.resteJour)+'/jour • Épargne potentielle : '+fmtPct(c.tauxEpargne);
    var list = document.getElementById('coachList'); list.innerHTML='';
    c.tips.slice(0,3).forEach(function(t){
      var div=document.createElement('div'); div.className='card'; div.style.padding='12px'; div.textContent=t; list.appendChild(div);
    });
  }

  function drawPie(){
    var svg = document.getElementById('pie');
    var legend = document.getElementById('legend');
    svg.innerHTML=''; legend.innerHTML='';
    var total = totalDepenses();
    if(total<=0){
      svg.innerHTML = '<text x="100" y="100" text-anchor="middle" fill="#8a90a6">Aucune dépense</text>';
      return;
    }
    var r = 80; var cx=100, cy=100; var PI2 = Math.PI*2;
    var start = -Math.PI/2;
    state.depenses.forEach(function(d){
      var val = Number(d.amount)||0; if(val<=0) return;
      var frac = val/total; var angle = frac*PI2; var end = start + angle;
      var x1 = cx + r*Math.cos(start), y1 = cy + r*Math.sin(start);
      var x2 = cx + r*Math.cos(end),   y2 = cy + r*Math.sin(end);
      var large = angle>Math.PI?1:0;
      var path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d','M '+x1+' '+y1+' A '+r+' '+r+' 0 '+large+' 1 '+x2+' '+y2);
      path.setAttribute('stroke', d.color||'#6ea8fe');
      path.setAttribute('stroke-width','32');
      path.setAttribute('fill','none');
      path.setAttribute('opacity','0.95');
      svg.appendChild(path);
      start = end;
      var li = document.createElement('div'); li.className='legend-item';
      li.innerHTML = '<span class="dot" style="background:'+d.color+'"></span><span>'+d.label+'</span><span style="margin-left:auto">'+fmt0(val)+'</span>';
      legend.appendChild(li);
    });
    var reste = computeReste();
    var mid = document.createElementNS('http://www.w3.org/2000/svg','text');
    mid.setAttribute('x','100'); mid.setAttribute('y','100'); mid.setAttribute('text-anchor','middle'); mid.setAttribute('fill','#cfe0ff'); mid.setAttribute('font-size','16');
    var t1=document.createElementNS('http://www.w3.org/2000/svg','tspan'); t1.setAttribute('x','100'); t1.setAttribute('dy','0'); t1.textContent='Reste';
    var t2=document.createElementNS('http://www.w3.org/2000/svg','tspan'); t2.setAttribute('x','100'); t2.setAttribute('dy','18'); t2.textContent=fmt0(reste);
    mid.appendChild(t1); mid.appendChild(t2); svg.appendChild(mid);
  }

  function renderKPIs(){
    var reste = computeReste();
    document.getElementById('kpiReste').textContent = fmt0(reste);
    document.getElementById('kpiResteJour').textContent = fmt2(reste/daysInMonth())+ '/jour';
    var taux = totalRevenus()>0 ? Math.max(reste,0)/totalRevenus() : 0;
    document.getElementById('kpiTaux').textContent = fmtPct(taux);
  }

  function renderRevenus(){
    var wrap = document.getElementById('revenusList'); wrap.innerHTML='';
    state.revenus.forEach(function(r,idx){
      var box=document.createElement('div'); box.className='grid';
      box.innerHTML = [
        '<label>Intitulé</label><input value="', r.label, '" data-idx="', idx, '" data-field="label" class="rev-input">',
        '<label>Montant (€)</label><input type="number" inputmode="decimal" value="', r.amount, '" data-idx="', idx, '" data-field="amount" class="rev-input">'
      ].join('');
      wrap.appendChild(box);
    });
  }
  function renderDepenses(){
    var wrap = document.getElementById('depensesList'); wrap.innerHTML='';
    state.depenses.forEach(function(d,idx){
      var box=document.createElement('div'); box.className='grid g2'; box.style.alignItems='end';
      box.innerHTML = [
        '<div>',
        '<label>Catégorie</label>',
        '<input value="', d.label, '" data-idx="', idx, '" data-field="label" class="dep-input">',
        '</div>',
        '<div>',
        '<label>Couleur</label>',
        '<input type="color" value="', d.color, '" data-idx="', idx, '" data-field="color" class="dep-input">',
        '</div>',
        '<div>',
        '<label>Montant (€)</label>',
        '<input type="number" inputmode="decimal" value="', d.amount, '" data-idx="', idx, '" data-field="amount" class="dep-input">',
        '</div>',
        '<div>',
        '<button class="btn del-cat" data-del="', idx, '">Supprimer</button>',
        '</div>'
      ].join('');
      wrap.appendChild(box);
    });
  }

  function showView(v){
    ['dashboard','epargne','emprunt','plus'].forEach(function(key){
      var el = document.getElementById('view-'+key);
      if(!el) return;
      if(key===v) el.classList.remove('hidden'); else el.classList.add('hidden');
    });
    Array.prototype.forEach.call(document.querySelectorAll('.tab'), function(t){
      t.classList.toggle('active', t.dataset.view===v);
    });
    if(v==='dashboard'){ drawPie(); renderKPIs(); renderCoach(); }
    if(v==='epargne'){ updateProjection(); }
    if(v==='emprunt'){ renderEmpruntFields(); }
  }

  function renderEmpruntFields(){
    var sync = !!state.emprunt.useSync;
    var total = totalRevenus();
    var empRevEl = document.getElementById('empRevenus');
    document.getElementById('syncEmprunt').checked = sync;
    if(sync){ empRevEl.value = total; empRevEl.disabled = true; }
    else { empRevEl.disabled = false; empRevEl.value = state.emprunt.revenus; }
    document.getElementById('empCharges').value = state.emprunt.charges;
    document.getElementById('empTaux').value = state.emprunt.taux;
    document.getElementById('empDuree').value = state.emprunt.duree;
    calcEmprunt();
  }
  function calcEmprunt(){
    var rev = Number(document.getElementById('empRevenus').value||0);
    var ch  = Number(document.getElementById('empCharges').value||0);
    var t   = Number(document.getElementById('empTaux').value||0)/100/12;
    var n   = Number(document.getElementById('empDuree').value||0)*12;
    var mensuMax = Math.max(0, 0.35*rev - ch);
    var montant = 0;
    if(t>0){ montant = mensuMax * (1 - Math.pow(1+t, -n)) / t; } else { montant = mensuMax * n; }
    document.getElementById('empMensu').textContent = fmt0(mensuMax);
    document.getElementById('empMontant').textContent = fmt0(montant);
  }

  function updateProjection(){
    var m = Number(document.getElementById('epargneMontant').value||0);
    var n = Number(document.getElementById('epargneDuree').value||0);
    var r = Number(document.getElementById('epargneRend').value||0)/100/12;
    var total = 0;
    if(r>0){ total = m * ((Math.pow(1+r, n) - 1) / r); } else total = m * n;
    document.getElementById('epargneProjection').textContent = fmt0(total);
    document.getElementById('epargneNote').textContent = r>0? 'Projection avec intérêt composé mensuel.' : 'Projection sans intérêt.';
  }

  function download(filename, content){
    var blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a'); a.href=url; a.download=filename; a.click();
    setTimeout(function(){ URL.revokeObjectURL(url); }, 500);
  }

  function bindEvents(){
    /* Tabs */
    document.querySelector('.bottom-nav').addEventListener('click', function(e){
      var a = e.target.closest('.tab'); if(!a) return;
      e.preventDefault(); showView(a.dataset.view);
    });

    /* Quick bridges */
    document.getElementById('btnRevenus').addEventListener('click', function(){ showView('plus'); window.scrollTo({top:0, behavior:'smooth'}); });
    document.getElementById('btnDepenses').addEventListener('click', function(){ showView('plus'); window.scrollTo({top:0, behavior:'smooth'}); });
    document.getElementById('btnTryEpargne').addEventListener('click', function(){ showView('epargne'); window.scrollTo({top:0, behavior:'smooth'}); });
    document.getElementById('backToDash').addEventListener('click', function(){ showView('dashboard'); window.scrollTo({top:0, behavior:'smooth'}); });
    document.getElementById('goToPlus').addEventListener('click', function(){ showView('plus'); window.scrollTo({top:0, behavior:'smooth'}); });

    /* Menus */
    var kebab = document.getElementById('kebab'); var sheet = document.getElementById('sheet');
    kebab.addEventListener('click', function(e){ e.stopPropagation(); sheet.classList.toggle('open'); });
    document.addEventListener('click', function(e){ if(!sheet.contains(e.target) && e.target!==kebab){ sheet.classList.remove('open'); } });

    var profBtn = document.getElementById('btnProfileMenu'); var profSheet = document.getElementById('profileSheet');
    profBtn.addEventListener('click', function(e){ e.stopPropagation(); profSheet.classList.toggle('open'); });
    document.addEventListener('click', function(e){ if(!profSheet.contains(e.target) && e.target!==profBtn){ profSheet.classList.remove('open'); } });

    document.getElementById('btnGuide').addEventListener('click', function(){ document.getElementById('helpModal').style.display='flex'; });
    document.getElementById('helpClose').addEventListener('click', function(){ document.getElementById('helpModal').style.display='none'; });

    document.getElementById('btnCoachDetails').addEventListener('click', function(){
      document.getElementById('coachDetails').classList.toggle('hidden');
    });

    /* Inputs */
    document.addEventListener('input', function(e){
      if(e.target.classList.contains('rev-input')){
        var i=+e.target.dataset.idx, f=e.target.dataset.field;
        state.revenus[i][f] = f==='amount'? Number(e.target.value||0): e.target.value;
        setState(state); renderKPIs(); renderCoach();
        if(state.emprunt.useSync){ renderEmpruntFields(); }
      }
      if(e.target.classList.contains('dep-input')){
        var i=+e.target.dataset.idx, f=e.target.dataset.field;
        state.depenses[i][f] = f==='amount'? Number(e.target.value||0): e.target.value;
        setState(state); drawPie(); renderKPIs(); renderCoach();
      }
      if(e.target.id==='brutVal' || e.target.id==='chargesPct' || e.target.id==='pasPct'){
        var brut = Number(document.getElementById('brutVal').value||0);
        var charges = Number(document.getElementById('chargesPct').value||0)/100;
        var pas = Number(document.getElementById('pasPct').value||0)/100;
        var netAvant = Math.max(0, brut * (1 - charges));
        var netApres = Math.max(0, netAvant * (1 - pas));
        document.getElementById('netAvant').value = netAvant ? Math.round(netAvant) : '';
        document.getElementById('netApres').value = netApres ? Math.round(netApres) : '';
      }
      if(e.target.id==='empRevenus' || e.target.id==='empCharges' || e.target.id==='empTaux' || e.target.id==='empDuree'){
        state.emprunt.revenus = Number(document.getElementById('empRevenus').value||0);
        state.emprunt.charges = Number(document.getElementById('empCharges').value||0);
        state.emprunt.taux    = Number(document.getElementById('empTaux').value||0);
        state.emprunt.duree   = Number(document.getElementById('empDuree').value||0);
        setState(state); calcEmprunt();
      }
    });

    document.addEventListener('click', function(e){
      var del = e.target.closest('.del-cat');
      if(del){ var i=+del.dataset.del; state.depenses.splice(i,1); setState(state); renderDepenses(); drawPie(); renderCoach(); }
    });

    document.getElementById('applyNetAvant').addEventListener('click', function(){
      var net = Number(document.getElementById('netAvant').value||0);
      if(net>0){
        var idx = state.revenus.findIndex(function(r){ return (r.label||'').toLowerCase().indexOf('salaire')>-1; });
        if(idx<0){ state.revenus.unshift({label:'Salaire net', amount:net}); }
        else { state.revenus[idx].amount = net; }
        setState(state); renderRevenus(); renderKPIs(); renderCoach(); if(state.emprunt.useSync){ renderEmpruntFields(); } alert('Salaire net (avant PAS) mis à jour');
      }
    });
    document.getElementById('applyNetApres').addEventListener('click', function(){
      var net = Number(document.getElementById('netApres').value||0);
      if(net>0){
        var idx = state.revenus.findIndex(function(r){ return (r.label||'').toLowerCase().indexOf('salaire')>-1; });
        if(idx<0){ state.revenus.unshift({label:'Salaire net', amount:net}); }
        else { state.revenus[idx].amount = net; }
        setState(state); renderRevenus(); renderKPIs(); renderCoach(); if(state.emprunt.useSync){ renderEmpruntFields(); } alert('Salaire net (après PAS) mis à jour');
      }
    });

    document.getElementById('syncEmprunt').addEventListener('change', function(){
      state.emprunt.useSync = !!this.checked; setState(state); renderEmpruntFields();
    });

    document.getElementById('addRevenu').addEventListener('click', function(){ state.revenus.push({label:'Autre revenu', amount:0}); renderRevenus(); });
    document.getElementById('addCategorie').addEventListener('click', function(){ state.depenses.push({label:'Nouvelle catégorie', color:'#7dd3fc', amount:0}); renderDepenses(); drawPie(); });
    document.getElementById('btnSaveAll').addEventListener('click', function(){ setState(state); alert('Sauvegarde OK'); });

    Array.prototype.forEach.call(document.querySelectorAll('.rate'), function(b){
      b.addEventListener('click', function(){
        var revenus = totalRevenus(); var reste = computeReste();
        var rate = b.dataset.rate;
        if(rate!=='perso'){
          var val = Math.round( Math.min( (Number(rate)/100)*revenus, 0.30*reste )/10)*10;
          document.getElementById('epargneMontant').value = val;
        }
        updateProjection();
      });
    });
    document.getElementById('epargneMontant').addEventListener('input', updateProjection);
    document.getElementById('epargneDuree').addEventListener('input', updateProjection);
    document.getElementById('epargneRend').addEventListener('input', updateProjection);
    document.getElementById('btnSaveEpargne').addEventListener('click', function(){
      state.epargne.montant = Number(document.getElementById('epargneMontant').value||0);
      state.epargne.duree   = Number(document.getElementById('epargneDuree').value||0);
      state.epargne.rendement = Number(document.getElementById('epargneRend').value||0);
      setState(state); alert('Objectif épargne enregistré');
    });

    /* Export / Import */
    document.getElementById('btnExportCSV').addEventListener('click', function(){
      var lines = [];
      lines.push('Type;Libellé;Montant');
      state.revenus.forEach(function(r){ lines.push('Revenu;'+r.label+';'+r.amount); });
      state.depenses.forEach(function(d){ lines.push('Dépense;'+d.label+';'+d.amount); });
      download('equilibrio_'+(state.meta?.name||'profil')+'.csv', '\\uFEFF'+lines.join('\\n'));
    });
    document.getElementById('btnExportJSON').addEventListener('click', function(){ download('equilibrio_'+(state.meta?.name||'profil')+'.json', JSON.stringify(state, null, 2)); });
    document.getElementById('btnImportJSON').addEventListener('click', function(){ document.getElementById('fileImport').click(); });
    document.getElementById('fileImport').addEventListener('change', function(e){
      var f = e.target.files[0]; if(!f) return; var rd = new FileReader();
      rd.onload = function(){ try{ var data = JSON.parse(rd.result); state=data; setState(state); initRender(); alert('Import réussi'); }catch(err){ alert('Fichier invalide'); } };
      rd.readAsText(f);
    });
    document.getElementById('btnPrint').addEventListener('click', function(){ window.print(); });
    document.getElementById('btnAbout').addEventListener('click', function(){ alert('Equilibrio - v2.0 - Multi-profils + Mini-Coach (offline)'); });

    /* Profiles UI */
    document.getElementById('profileSelect').addEventListener('change', function(){
      ALL.currentId = this.value; saveAll(); state = getState(); initRender();
    });
    document.getElementById('btnAddProfile').addEventListener('click', function(){
      var name = prompt('Nom du nouveau profil ?', 'Couple');
      if(name){ addProfile(name); }
    });
    document.getElementById('btnRenameProfile').addEventListener('click', function(){
      var id = ALL.currentId;
      var name = prompt('Nouveau nom du profil :', ALL.profiles[id].meta?.name||'Profil');
      if(name){ renameProfile(id, name); }
    });
    document.getElementById('btnDuplicateProfile').addEventListener('click', function(){
      duplicateProfile(ALL.currentId);
    });
    document.getElementById('btnDeleteProfile').addEventListener('click', function(){
      var id = ALL.currentId, nm = ALL.profiles[id].meta?.name||'Profil';
      if(confirm('Supprimer le profil “‘+nm+’” ?')){ deleteProfile(id); }
    });
  }

  function initRender(){
    renderProfileSelect();
    state = getState();
    renderRevenus(); renderDepenses(); renderKPIs(); drawPie(); renderCoach(); renderEmpruntFields(); updateProjection();
    showView('dashboard');
  }

  function safeInit(){
    try{ bindEvents(); initRender(); console.log('[Equilibrio] v2.0 Init OK'); }
    catch(err){ console.error(err); alert('Erreur init : '+err.message); }
  }

  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', safeInit); }
  else { safeInit(); }

})();</script>
</body>
</html>
