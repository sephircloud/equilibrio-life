<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Equilibrio Life 1.7.0 ‚Äî Quotidien + Journal + Donut segment√©</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --ink:#111827; --muted:#6b7280; --accent:#2563eb;
    --surface:#eef2f7; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --line:#d1d5db;
    --radius:14px;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
    font:500 16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  *{box-sizing:border-box}
  .wrap{max-width:980px;margin:8px auto 28px;padding:0 12px}
  .appbar{position:sticky;top:0;z-index:10;background:var(--bg);
    display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 4px 8px}
  h1{font:800 20px/1.1 system-ui;margin:0}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{border:1px solid #cbd5e1;background:#fff;color:#111827;padding:10px 14px;border-radius:999px;cursor:pointer}
  .tabs{display:flex;gap:8px;flex-wrap:nowrap;overflow:auto;margin-bottom:4px}
  .tab{border:1px solid #cbd5e1;background:#fff;color:#111827;padding:12px 16px;border-radius:12px;cursor:pointer;flex:0 0 auto}
  .tab.active{background:var(--accent);border-color:var(--accent);color:#fff}
  .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 3px 12px rgba(0,0,0,.06);margin-top:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:800px){.row{grid-template-columns:1fr}}
  label{display:flex;flex-direction:column;color:var(--muted);font-size:14px}
  input,select,textarea{width:100%;max-width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:#111827;margin-top:6px;font-size:16px}
  .btn{border:none;background:var(--accent);color:#fff;padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:700}
  .btn.secondary{background:#334155}
  .btn.ghost{background:transparent;color:#111827;border:1px solid #334155}
  .btn.warn{background:var(--warn)}
  .btn.ok{background:var(--ok)}
  .kpi{background:var(--surface);border:1px solid rgba(0,0,0,.06);border-radius:12px;padding:12px;margin-top:8px}
  .kpi strong{float:right}
  .hint{color:var(--muted);font-size:13px;margin-top:4px}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  @media (max-width:800px){.grid3{grid-template-columns:1fr}}

  /* DONUT */
  .donutBox{display:flex;align-items:center;gap:18px;flex-wrap:wrap}
  .donut{width:140px;height:140px;overflow:visible;flex-shrink:0}
  .donut text#donutMain{font-size:16px;font-weight:800;text-anchor:middle;dominant-baseline:middle}
  .donut text.small{font-size:10px;font-weight:600;fill:#6b7280;text-anchor:middle;dominant-baseline:middle}
  .legend{display:flex;gap:12px;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-size:12px}
  .dot{width:10px;height:10px;border-radius:999px}

  /* Floating action button */
  .fab{position:fixed;right:18px;bottom:86px;background:var(--accent);color:#fff;border:none;border-radius:999px;width:56px;height:56px;font-size:28px;cursor:pointer;box-shadow:0 6px 20px rgba(37,99,235,.4)}
  /* Bottom Nav */
  .bottomnav{position:sticky;bottom:0;left:0;right:0;background:var(--bg);display:flex;gap:8px;justify-content:space-between;padding:10px 6px}
  .bottomnav .tab{flex:1;text-align:center}
  #toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:.25s}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(17,24,39,.5);display:none;align-items:center;justify-content:center;padding:20px}
  .modal .sheet{background:#fff;border-radius:16px;max-width:420px;width:100%;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)}

  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
  th{color:#6b7280;font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <div class="appbar">
    <h1>Equilibrio Life</h1>
    <div class="toolbar">
      <select id="profileSelect" aria-label="Profil"></select>
      <button class="pill" id="btnNewProfile" type="button" title="Nouveau profil">+ Profil</button>
      <button class="pill" id="btnRenameProfile" type="button" title="Renommer ce profil">‚úèÔ∏è Renommer</button>
      <button class="pill" id="btnSaveProfile" type="button" title="Sauver ce profil">üíæ Sauver</button>
      <button class="pill" id="btnDeleteProfile" type="button" title="Supprimer ce profil">üóëÔ∏è Suppr.</button>
      <button class="pill" id="btnHelp" type="button" title="Aide rapide">‚ùì Aide</button>
    </div>
  </div>

  <div class="tabs">
    <button data-tab="Today" class="tab active" type="button">Aujourd‚Äôhui</button>
    <button data-tab="Budget" class="tab" type="button">Budget & Fixes</button>
    <button data-tab="EpargneFromReste" class="tab" type="button">√âpargne</button>
    <button data-tab="Emprunt" class="tab" type="button">Emprunt</button>
    <button data-tab="Aide" class="tab" type="button">Aide</button>
  </div>

  <!-- AUJOURD'HUI -->
  <section id="viewToday" class="card">
    <h2>Vue du jour</h2>
    <div class="row">
      <div>
        <div class="kpi">Reste √† vivre initial : <strong id="resteInitial">‚Äî</strong></div>
        <div class="kpi">Variables d√©pens√©es (mois) : <strong id="varsDepensees">‚Äî</strong></div>
        <div class="kpi">Reste variables dispo : <strong id="varsRestantes">‚Äî</strong></div>
        <div class="kpi">Reste conseill√© / jour : <strong id="parJour">‚Äî</strong></div>
        <div class="hint" id="alertMsg"></div>
        <div class="row" style="margin-top:8px">
          <label>Budget variables du mois (‚Ç¨)
            <input id="budgetVars" type="number" step="0.01" placeholder="ex: 600">
          </label>
          <button class="btn ok" id="btnSaveBudget" type="button" style="align-self:end">Enregistrer</button>
        </div>
        <div class="hint">Fixe-le une fois, modifiable quand tu veux. Sert au calcul des alertes.</div>
      </div>
      <div>
        <h3>Vue rapide</h3>
        <div class="donutBox">
          <svg id="donut" class="donut" viewBox="0 0 42 42" aria-label="R√©partition">
            <!-- Fond -->
            <circle cx="21" cy="21" r="15.915" fill="white"/>
            <circle cx="21" cy="21" r="15.915" fill="none" stroke="#e5e7eb" stroke-width="8"></circle>
            <!-- Segments: ordre = impots, fixes, variables, reste -->
            <g id="arcs" transform="rotate(-90 21 21)">
              <circle id="arcImpots"    cx="21" cy="21" r="15.915" fill="none" stroke="#8b5cf6" stroke-width="8" stroke-dasharray="0 100" stroke-linecap="butt"></circle>
              <circle id="arcFixes"     cx="21" cy="21" r="15.915" fill="none" stroke="#f59e0b" stroke-width="8" stroke-dasharray="0 100" stroke-linecap="butt"></circle>
              <circle id="arcVariables" cx="21" cy="21" r="15.915" fill="none" stroke="#ef4444" stroke-width="8" stroke-dasharray="0 100" stroke-linecap="butt"></circle>
              <circle id="arcReste"     cx="21" cy="21" r="15.915" fill="none" stroke="#10b981" stroke-width="8" stroke-dasharray="0 100" stroke-linecap="butt"></circle>
            </g>
            <!-- Centre -->
            <circle cx="21" cy="21" r="9.5" fill="white"></circle>
            <text x="21" y="20.5" id="donutMain">‚Äî</text>
            
          </svg>
          <div>
            <div class="legend">
              <span class="badge"><span class="dot" style="background:#8b5cf6"></span> Imp√¥ts</span>
              <span class="badge"><span class="dot" style="background:#f59e0b"></span> Fixes</span>
              <span class="badge"><span class="dot" style="background:#ef4444"></span> Variables</span>
              <span class="badge"><span class="dot" style="background:#10b981"></span> Reste</span>
            </div>
            <div class="kpi">Net apr√®s imp√¥t : <strong id="netApres_today">‚Äî</strong></div>
            <div class="hint">Base du donut¬†: <em>net avant PAS</em> (net + imp√¥ts pr√©lev√©s √† la source).</div>
          </div>
        </div>
      </div>
    </div>

    <h3 style="margin-top:12px">D√©penses variables (mois en cours)</h3>
    <div class="row">
      <div>
        <table id="tblDepenses">
          <thead><tr><th>Date</th><th>Cat√©gorie</th><th>Montant</th><th>Note</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="hint" id="sumLine">Total: ‚Äî</div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="btnExportCSV" type="button">Exporter CSV</button>
          <button class="btn secondary" id="btnClearMonth" type="button">Vider le mois</button>
        </div>
      </div>
      <div>
        <div class="card">
          <h4>Ajouter une d√©pense</h4>
          <label>Date <input id="expDate" type="date"></label>
          <label>Montant (‚Ç¨) <input id="expAmount" type="number" step="0.01" placeholder="ex: 12.90"></label>
          <label>Cat√©gorie
            <select id="expCat">
              <option>Courses</option><option>Resto</option><option>Transport</option>
              <option>Loisirs</option><option>Impr√©vus</option>
            </select>
          </label>
          <label>Note <input id="expNote" type="text" maxlength="80" placeholder="(facultatif)"></label>
          <button class="btn ok" id="btnAddExp" type="button" style="margin-top:8px">+ Ajouter</button>
        </div>
      </div>
    </div>
  </section>

  <!-- BUDGET (salaire & fixes) -->
  <section id="viewBudget" class="card" style="display:none">
    <div class="row">
      <div>
        <h2>Budget & Charges fixes</h2>
        <label>Brut mensuel (‚Ç¨)<input id="brut" type="number" step="0.01" placeholder="3000"></label>
        <label>Charges salari√© (%)<input id="charges" type="number" step="0.01" value="23"></label>
        <label>Taux PAS (%)<input id="pas" type="number" step="0.01" value="0"></label>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="btnCalcSalaire" type="button">Calculer le net</button>
          <div class="kpi">Net apr√®s imp√¥t : <strong id="netApres">‚Äî</strong></div>
        </div>
        <h3 style="margin-top:8px">Charges fixes (mensuelles)</h3>
        <div class="row">
          <label>Loyer (‚Ç¨)<input id="loyer" type="number" step="0.01" value="0"></label>
          <label>√ânergie (‚Ç¨)<input id="energie" type="number" step="0.01" value="0"></label>
          <label>Internet/T√©l√©phone (‚Ç¨)<input id="internet" type="number" step="0.01" value="0"></label>
          <label>Assurances (‚Ç¨)<input id="assurances" type="number" step="0.01" value="0"></label>
          <label>Abonnements (‚Ç¨)<input id="abos" type="number" step="0.01" value="0"></label>
          <label>Transports (‚Ç¨)<input id="transports" type="number" step="0.01" value="0"></label>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn secondary" id="btnCalcCharges" type="button">Mettre √† jour</button>
          <div class="kpi">Total charges fixes : <strong id="chargesFixes">‚Äî</strong></div>
        </div>
      </div>
      <div>
        <h3>Notes</h3>
        <div class="hint">Le donut de la page ‚ÄúAujourd‚Äôhui‚Äù affiche Imp√¥ts (PAS), Fixes, Variables du mois et Reste.</div>
        <div class="hint">Tu peux g√©rer plusieurs profils en haut.</div>
      </div>
    </div>
  </section>

  <!-- EPARGNE -->
  <section id="viewEpargneFromReste" class="card" style="display:none">
    <h2>√âpargne mensuelle √† partir du reste √† vivre</h2>
    <div class="kpi">Reste √† vivre actuel (depuis Budget) : <strong id="rvRef">‚Äî</strong></div>
    <div class="row" style="margin-top:8px">
      <label>Capital initial (‚Ç¨)<input id="capInit" type="number" step="0.01" value="0"></label>
      <label>Montant √©pargn√© par mois (‚Ç¨)<input id="epargneMensuelle" type="number" step="0.01" placeholder="ex: 200"></label>
      <label>Ou % du reste √† vivre (%)<input id="pctReste" type="number" step="0.01" value="0"></label>
      <label>Horizon (ann√©es)<input id="horizon" type="number" step="1" value="5"></label>
    </div>
    <h3>Rendement</h3>
    <div class="grid3">
      <div class="card">
        <label>Pr√©r√©glages
          <select id="presetRendement">
            <option value="3">Prudent ~3%/an</option>
            <option value="5">√âquilibr√© ~5%/an</option>
            <option value="7">Dynamique ~7%/an</option>
            <option value="custom">Personnalis√©‚Ä¶</option>
          </select>
        </label>
        <label>Taux annuel (%) ‚Äî si personnalis√©<input id="tauxAnnuel" type="number" step="0.01" value="5"></label>
        <button class="btn" id="btnSimulerEpargne" type="button" style="margin-top:8px">Simuler</button>
      </div>
      <div class="card">
        <div class="kpi">Capital final estim√© : <strong id="capFinal">‚Äî</strong></div>
        <div class="kpi">Int√©r√™ts cumul√©s : <strong id="interetsCumules">‚Äî</strong></div>
      </div>
      <div class="card">
        <h4>R√©capitulatif</h4>
        <div id="recapEpargne" class="hint">Renseigne un montant mensuel ou un % du reste √† vivre.</div>
      </div>
    </div>
  </section>

  <!-- EMPRUNT -->
  <section id="viewEmprunt" class="card" style="display:none">
    <h2>Capacit√© d'emprunt</h2>
    <div class="kpi">Net mensuel (depuis Budget) : <strong id="netRef">‚Äî</strong></div>
    <div class="row" style="margin-top:8px">
      <label>Taux d'endettement max (%)<input id="txEndettement" type="number" step="0.1" value="35"></label>
      <label>Autres cr√©dits mensuels (‚Ç¨)<input id="autresCredits" type="number" step="0.01" value="0"></label>
      <label>Taux nominal annuel (%)<input id="txNominal" type="number" step="0.01" value="4"></label>
      <label>Dur√©e (ann√©es)<input id="duree" type="number" step="1" value="25"></label>
      <label>Assurance emprunteur (%/an du capital initial)<input id="txAssurance" type="number" step="0.01" value="0.25"></label>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnSimulerEmprunt" type="button">Calculer la capacit√©</button>
      <div class="kpi">Mensualit√© max log√©e : <strong id="mensuMax">‚Äî</strong></div>
      <div class="kpi">Capital empruntable estim√© : <strong id="capEmprunt">‚Äî</strong></div>
    </div>
  </section>

  <!-- AIDE -->
  <section id="viewAide" class="card" style="display:none">
    <h2>Aide</h2>
    <h3>D√©marrage rapide (3 minutes)</h3>
    <ol>
      <li><strong>Va dans ‚ÄúBudget & Fixes‚Äù</strong> et remplis : Brut mensuel, % de charges salari√©, % PAS (pr√©lev√© √† la source). Clique ‚ÄúCalculer le net‚Äù.</li>
      <li><strong>Entre tes charges fixes</strong> (loyer, √©nergie, etc.), puis ‚ÄúMettre √† jour‚Äù. Le <em>reste √† vivre initial</em> est calcul√©.</li>
      <li><strong>Reviens dans ‚ÄúAujourd‚Äôhui‚Äù</strong> : choisis ton <em>budget variables du mois</em> (ex. 600‚Ç¨) et ‚ÄúEnregistrer‚Äù.</li>
      <li><strong>Ajoute tes d√©penses variables</strong> au fil du mois (montant + cat√©gorie + note optionnelle). Le total s‚Äôajuste et la jauge ‚Ç¨/jour aussi.</li>
    </ol>

    <h3>Comment lire l‚Äôonglet ‚ÄúAujourd‚Äôhui‚Äù</h3>
    <ul>
      <li><strong>Reste √† vivre initial</strong> = Net apr√®s imp√¥t ‚Äì Charges fixes (de ‚ÄúBudget & Fixes‚Äù).</li>
      <li><strong>Variables d√©pens√©es</strong> = somme de tes entr√©es dans le journal du mois en cours.</li>
      <li><strong>Reste variables dispo</strong> = Budget variables ‚Äì Variables d√©pens√©es.</li>
      <li><strong>Reste conseill√© / jour</strong> = (Reste variables dispo) √∑ (jours restants du mois).</li>
      <li><strong>Donut segment√©</strong> : la base est le <em>net avant PAS</em> (ton net + imp√¥ts pr√©lev√©s √† la source), d√©coup√© en Imp√¥ts, Fixes, Variables et Reste. √áa permet de visualiser aussi le poids de l‚Äôimp√¥t.</li>
    </ul>

    <h3>Conseils d‚Äôusage</h3>
    <ul>
      <li>Fixe un budget variables <em>r√©aliste</em> : un peu en dessous de ton historique, pas au-dessus.</li>
      <li>Prends 20 secondes chaque soir pour noter 1‚Äì2 d√©penses. Le suivi reste utile uniquement s‚Äôil est simple.</li>
      <li>En fin de mois : exporte le CSV, ou note juste le total pour comparer d‚Äôun mois sur l‚Äôautre.</li>
    </ul>

    <h3>FAQ</h3>
    <p><strong>Pourquoi le donut n‚Äôest pas ‚ÄúNet apr√®s imp√¥t‚Äù‚ÄØ?</strong><br>
       Parce qu‚Äôon veut visualiser aussi la part d‚Äô<em>Imp√¥ts (PAS)</em>. Le donut se base sur le <em>net avant PAS</em> = net + imp√¥ts. Le KPI ‚ÄúNet apr√®s imp√¥t‚Äù est affich√© juste en dessous pour r√©f√©rence.</p>
    <p><strong>Je ne veux pas d‚ÄôImp√¥ts dans le donut.</strong><br>
       Va pour une version simplifi√©e (Fixes / Variables / Reste). Dis‚Äële et on basculera l‚Äôaffichage.</p>
    <p><strong>Je change de profil, mes d√©penses du mois disparaissent‚ÄØ?</strong><br>
       Chaque profil a son propre journal mensuel (stock√© en local). Tu peux basculer sans rien perdre.</p>
  </section>

  <div class="bottomnav">
    <button data-tab="Today" class="tab active" type="button">Aujourd‚Äôhui</button>
    <button data-tab="Budget" class="tab" type="button">Budget</button>
    <button data-tab="EpargneFromReste" class="tab" type="button">√âpargne</button>
    <button data-tab="Emprunt" class="tab" type="button">Emprunt</button>
    <button data-tab="Aide" class="tab" type="button">Aide</button>
  </div>
</div>
<div id="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  // === Globals
  let netApresGlobal=0, chargesFixesGlobal=0, resteVivreGlobal=0, mntPASGlobal=0, netAvantGlobal=0;
  const fmtEUR = new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'});
  const euros = n => fmtEUR.format(n || 0);
  const today = new Date();
  const monthKey = (d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`)(today);
  const DAYS_IN_MONTH = new Date(today.getFullYear(), today.getMonth()+1, 0).getDate();
  const DAYS_LEFT = DAYS_IN_MONTH - today.getDate() + 1; // incl. today

  // === Profiles (reuse 1.6.x logic)
  function defaultProfile(name='Profil 1'){
    return {
      name,
      salaire:{brut:3000, charges:23, pas:0},
      chargesFixes:{loyer:0,energie:0,internet:0,assurances:0,abos:0,transports:0},
      epargne:{capInit:0, epargneMensuelle:0, pctReste:0, horizon:5, tauxAnnuel:5},
      emprunt:{txEndettement:35, autresCredits:0, txNominal:4, duree:25, txAssurance:0.25},
      settings:{budgetVars:0}
    };
  }
  function getProfiles(){
    let p = JSON.parse(localStorage.getItem('eq_profiles_ultra162')||'[]');
    if(!Array.isArray(p) || p.length===0){ p=[defaultProfile()]; localStorage.setItem('eq_profiles_ultra162',JSON.stringify(p)); }
    // ensure settings
    p.forEach(x=>{ if(!x.settings) x.settings={budgetVars:0}; });
    return p;
  }
  function saveProfiles(list){ localStorage.setItem('eq_profiles_ultra162', JSON.stringify(list)); }
  function loadProfileNames(){ const sel = document.getElementById('profileSelect'); sel.innerHTML=''; getProfiles().forEach((p,i)=>{ const opt=document.createElement('option'); opt.value=i; opt.textContent=p.name; sel.appendChild(opt); }); }
  function currentProfileIndex(){ return +document.getElementById('profileSelect').value||0; }
  function currentProfile(){ return getProfiles()[currentProfileIndex()]; }

  function applyProfile(p){
    // Budget
    setVal('brut', p.salaire.brut); setVal('charges', p.salaire.charges); setVal('pas', p.salaire.pas);
    for(const k of ['loyer','energie','internet','assurances','abos','transports']) setVal(k, p.chargesFixes[k]||0);
    // Epargne
    setVal('capInit', p.epargne.capInit||0); setVal('epargneMensuelle', p.epargne.epargneMensuelle||0);
    setVal('pctReste', p.epargne.pctReste||0); setVal('horizon', p.epargne.horizon||5); setVal('tauxAnnuel', p.epargne.tauxAnnuel||5);
    document.getElementById('presetRendement').value = ['3','5','7'].includes(String(p.epargne.tauxAnnuel)) ? String(p.epargne.tauxAnnuel) : 'custom';
    // Emprunt
    setVal('txEndettement', p.emprunt.txEndettement||35); setVal('autresCredits', p.emprunt.autresCredits||0);
    setVal('txNominal', p.emprunt.txNominal||4); setVal('duree', p.emprunt.duree||25); setVal('txAssurance', p.emprunt.txAssurance||0.25);
    // Settings
    setVal('budgetVars', p.settings?.budgetVars || 0);
    // Recalcule
    calcSalaire(); calcCharges(); majResteVivre(); majRefs(); majToday();
  }
  function snapshotFromUI(){
    const base = getProfiles();
    const idx = currentProfileIndex();
    return {
      name: base[idx]?.name || 'Profil',
      salaire:{brut:+num('brut'), charges:+num('charges'), pas:+num('pas')},
      chargesFixes:{ loyer:+num('loyer'), energie:+num('energie'), internet:+num('internet'), assurances:+num('assurances'), abos:+num('abos'), transports:+num('transports') },
      epargne:{ capInit:+num('capInit'), epargneMensuelle:+num('epargneMensuelle'), pctReste:+num('pctReste'), horizon:parseInt(val('horizon')||'5',10), tauxAnnuel:+num('tauxAnnuel') },
      emprunt:{ txEndettement:+num('txEndettement'), autresCredits:+num('autresCredits'), txNominal:+num('txNominal'), duree:parseInt(val('duree')||'25',10), txAssurance:+num('txAssurance') },
      settings:{ budgetVars:+num('budgetVars') }
    };
  }
  function initProfiles(){ loadProfileNames(); document.getElementById('profileSelect').value=0; applyProfile(getProfiles()[0]); }
  document.getElementById('btnNewProfile').addEventListener('click', ()=>{
    const nm = prompt("Nom du nouveau profil :", "Profil "+(getProfiles().length+1)); if(!nm) return;
    const list = getProfiles(); list.push(defaultProfile(nm)); saveProfiles(list); loadProfileNames(); document.getElementById('profileSelect').value=list.length-1; applyProfile(list[list.length-1]);
  });
  document.getElementById('btnRenameProfile').addEventListener('click', ()=>{
    const idx = currentProfileIndex(); const list=getProfiles();
    const nm = prompt("Nouveau nom du profil :", list[idx].name || ("Profil "+(idx+1))); if(!nm) return;
    list[idx].name = nm.trim(); saveProfiles(list); loadProfileNames(); document.getElementById('profileSelect').value=idx;
  });
  document.getElementById('btnSaveProfile').addEventListener('click', ()=>{
    const idx = currentProfileIndex(); const list=getProfiles(); list[idx] = snapshotFromUI(); saveProfiles(list); toast("Profil enregistr√©.");
  });
  document.getElementById('btnDeleteProfile').addEventListener('click', ()=>{
    const idx = currentProfileIndex(); const list=getProfiles();
    if(list.length<=1){ alert("Il faut garder au moins un profil."); return; }
    if(confirm(`Supprimer le profil "${list[idx].name}" ?`)){
      list.splice(idx,1); saveProfiles(list); loadProfileNames(); document.getElementById('profileSelect').value=0; applyProfile(getProfiles()[0]);
    }
  });
  document.getElementById('profileSelect').addEventListener('change', (e)=>{ applyProfile(getProfiles()[+e.target.value||0]); });

  // === NAV
  function showTab(t){
    document.querySelectorAll('section').forEach(s=>s.style.display='none');
    document.getElementById('view'+t).style.display='block';
    document.querySelectorAll('.tabs .tab, .bottomnav .tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll(`[data-tab="${t}"]`).forEach(b=>b.classList.add('active'));
  }
  document.querySelectorAll('[data-tab]').forEach(btn=>{ btn.addEventListener('click', ()=> showTab(btn.getAttribute('data-tab'))); });
  document.getElementById('btnHelp').addEventListener('click', ()=> showTab('Aide'));

  // === DOM utils
  const val=id=>document.getElementById(id).value;
  const setVal=(id,v)=>document.getElementById(id).value=v;
  const setTxt=(id,t)=>document.getElementById(id).textContent=t;
  const num = (id)=>{ const t=(val(id)||'').toString().replace(',','.'); const n=parseFloat(t); return isNaN(n)?0:n; };
  function toast(t){ const el=document.getElementById('toast'); el.textContent=t; el.style.opacity=1; setTimeout(()=>el.style.opacity=0,1500); }

  // === Calculs Budget
  function calcSalaire(){
    const brut=num('brut'), charges=num('charges')/100, pas=num('pas')/100;
    const netAvant = brut*(1-charges);
    const netImposable = netAvant + brut*0.029;
    const mntPAS = netImposable*pas;
    const netApres = netAvant - mntPAS;
    netAvantGlobal = netAvant;
    mntPASGlobal = mntPAS;
    netApresGlobal = netApres;
    setTxt('netApres', euros(netApres));
    setTxt('netApres_today', euros(netApres));
    majResteVivre(); majRefs(); majToday();
  }
  function calcCharges(){
    const l=num('loyer'), e=num('energie'), it=num('internet'), a=num('assurances'), ab=num('abos'), t=num('transports');
    const total = l+e+it+a+ab+t;
    chargesFixesGlobal = total;
    setTxt('chargesFixes', euros(total));
    majResteVivre(); majRefs(); majToday();
  }
  function majResteVivre(){ resteVivreGlobal = Math.max(0, (netApresGlobal||0) - (chargesFixesGlobal||0)); }
  function majRefs(){ setTxt('rvRef', euros(resteVivreGlobal)); setTxt('netRef', euros(netApresGlobal)); setTxt('resteInitial', euros(resteVivreGlobal)); }

  document.getElementById('btnCalcSalaire').addEventListener('click', calcSalaire);
  document.getElementById('btnCalcCharges').addEventListener('click', calcCharges);

  // === Journal des d√©penses (localStorage par mois et profil)
  function journalKey(){ return `EQ_JOURNAL_${monthKey}_P${currentProfileIndex()}`; }
  function loadJournal(){ return JSON.parse(localStorage.getItem(journalKey())||'[]'); }
  function saveJournal(list){ localStorage.setItem(journalKey(), JSON.stringify(list)); }
  function addExpense(item){
    const list = loadJournal(); list.push(item); saveJournal(list); renderJournal();
  }
  function deleteExpense(idx){
    const list = loadJournal(); list.splice(idx,1); saveJournal(list); renderJournal();
  }
  function sumJournal(){ return loadJournal().reduce((s,x)=>s + (+x.amount||0), 0); }

  // UI Journal
  function renderJournal(){
    const tb = document.querySelector('#tblDepenses tbody'); tb.innerHTML='';
    const list = loadJournal();
    list.forEach((x,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${x.date}</td><td>${x.cat}</td><td>${euros(+x.amount||0)}</td><td>${(x.note||'')}</td><td><button class="btn warn" data-del="${i}" type="button">Suppr.</button></td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll('button[data-del]').forEach(b=>b.addEventListener('click', ()=> deleteExpense(+b.getAttribute('data-del'))));
    const total = sumJournal();
    setTxt('sumLine', 'Total : '+euros(total));
    majToday();
  }

  // Ajouter d√©pense
  (function initAddExp(){
    const d = document.getElementById('expDate'); d.valueAsDate = new Date();
    document.getElementById('btnAddExp').addEventListener('click', ()=>{
      const date = val('expDate') || new Date().toISOString().slice(0,10);
      const amount = parseFloat((val('expAmount')||'').replace(',','.'));
      if(!(amount>0)) { alert("Montant invalide."); return; }
      const cat = val('expCat'); const note = val('expNote');
      addExpense({date, amount, cat, note});
      setVal('expAmount',''); setVal('expNote',''); toast("Ajout√©.");
    });
    document.getElementById('btnClearMonth').addEventListener('click', ()=>{
      if(confirm("Supprimer toutes les d√©penses de ce mois ?")){ saveJournal([]); renderJournal(); }
    });
    document.getElementById('btnExportCSV').addEventListener('click', ()=>{
      const rows = [['date','cat√©gorie','montant','note']].concat(loadJournal().map(x=>[x.date,x.cat, String(x.amount).replace('.',','), (x.note||'')]));
      const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(';')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`equilibrio_${monthKey}.csv`; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
    });
  })();

  // Budget variables param
  document.getElementById('btnSaveBudget').addEventListener('click', ()=>{
    const idx=currentProfileIndex(); const list=getProfiles();
    const v = +num('budgetVars'); list[idx].settings = list[idx].settings || {}; list[idx].settings.budgetVars = v;
    saveProfiles(list); toast("Budget variables enregistr√©."); majToday();
  });

  // === Donut segment√© (base = net avant PAS)
  function setArcs(pImpots, pFixes, pVars, pReste){
    const arcs=['arcImpots','arcFixes','arcVariables','arcReste'];
    const P=[pImpots,pFixes,pVars,pReste].map(x=>Math.max(0, Math.min(100,x)));
    let offset=0;
    arcs.forEach((id, i)=>{
      const el=document.getElementById(id);
      const val = P[i];
      el.setAttribute('stroke-dasharray', `${val} ${100-val}`);
      el.setAttribute('stroke-dashoffset', `${offset}`);
      offset -= val;
    });
    document.getElementById('donutMain').textContent = (P[3] + P[2])>0 ? `${Math.round(P[3])}%` : '‚Äî';
  }

  // === Vue du jour (calculs)
  function majToday(){
    // Base du donut = netAvant (avant PAS) pour afficher un segment Imp√¥ts
    const totalBase = Math.max(0, netAvantGlobal || 0);
    const impots = Math.min(mntPASGlobal||0, totalBase);
    const fixes = Math.min(chargesFixesGlobal||0, Math.max(0,totalBase-impots));
    const vars = Math.min(sumJournal(), Math.max(0,totalBase-impots-fixes));
    const reste = Math.max(0, totalBase - impots - fixes - vars);

    const pImp = totalBase>0 ? (impots/totalBase)*100 : 0;
    const pFix = totalBase>0 ? (fixes/totalBase)*100 : 0;
    const pVar = totalBase>0 ? (vars/totalBase)*100 : 0;
    const pRes = 100 - pImp - pFix - pVar;
    setArcs(pImp, pFix, pVar, pRes);

    // Cartes Aujourd'hui
    const budgetVars = +num('budgetVars');
    const depenses = sumJournal();
    const restantVars = Math.max(0, budgetVars - depenses);
    const parJour = budgetVars>0 && DAYS_LEFT>0 ? (restantVars / DAYS_LEFT) : 0;
    setTxt('varsDepensees', euros(depenses));
    setTxt('varsRestantes', euros(restantVars));
    setTxt('parJour', euros(parJour));

    // Alerte douce
    let msg='';
    const ratio = budgetVars>0 ? depenses / budgetVars : 0;
    if(budgetVars>0){
      if(ratio < 0.7) { msg = "Tu es dans le vert. Continue tranquille."; }
      else if(ratio < 0.9){ msg = "Attention, tu approches de la limite du mois."; }
      else if(ratio <= 1){ msg = "Zone rouge : ralentir sur le variable pour finir le mois propre."; }
      else { msg = "Budget d√©pass√©. Cap √† tenir : "+euros(parJour)+" par jour pour limiter la casse."; }
    }else{
      msg = "Fixe ton budget variables pour activer les alertes.";
    }
    setTxt('alertMsg', msg);
  }

  // === √âpargne
  document.getElementById('presetRendement').addEventListener('change', ()=>{
    const v = val('presetRendement'); if(v!=='custom'){ setVal('tauxAnnuel', v); }
  });
  function epargneMensuelleEffective(){
    const m = num('epargneMensuelle');
    const p = num('pctReste');
    const fromPct = p>0 ? (resteVivreGlobal||0) * p/100 : 0;
    return m>0 ? m : fromPct;
  }
  function simulerEpargne(){
    const P = num('capInit');
    const C = epargneMensuelleEffective();
    const r = num('tauxAnnuel')/100;
    const nYears = parseInt(val('horizon')||'5',10);
    const m = Math.max(0, nYears)*12;
    const i = r/12;
    let cap = P*Math.pow(1+i, m) + (C>0 && i>0 ? C*((Math.pow(1+i,m)-1)/i) : (C*m));
    if(!isFinite(cap)) cap = 0;
    const totalVerse = P + C*m;
    const interets = Math.max(0, cap - totalVerse);
    setTxt('capFinal', euros(cap)); setTxt('interetsCumules', euros(interets));
    const recap = [
      'Capital initial : '+euros(P),
      '√âpargne mensuelle : '+euros(C),
      'Horizon : '+nYears+' ans',
      'Taux annuel : '+(r*100).toFixed(2)+'%'
    ].join(' ‚Ä¢ ');
    document.getElementById('recapEpargne').textContent = recap;
  }
  document.getElementById('btnSimulerEpargne').addEventListener('click', simulerEpargne);

  // === Emprunt
  function simulerEmprunt(){
    const net = netApresGlobal||0;
    const txEnd = num('txEndettement')/100;
    const autres = num('autresCredits');
    const mensuMaxTheo = Math.max(0, net*txEnd - autres);
    const r = num('txNominal')/100/12;
    const n = Math.max(1, parseInt(val('duree')||'25',10)*12);
    const aAss = num('txAssurance')/100;
    const K = (r>0 ? (r/(1-Math.pow(1+r,-n))) : (1/n)) + (aAss/12);
    const P = K>0 ? (mensuMaxTheo / K) : 0;
    setTxt('mensuMax', euros(mensuMaxTheo));
    setTxt('capEmprunt', euros(P));
  }
  document.getElementById('btnSimulerEmprunt').addEventListener('click', simulerEmprunt);

  // === Init
  function initAll(){
    loadProfileNames();
    document.getElementById('profileSelect').value=0;
    applyProfile(getProfiles()[0]);
    renderJournal();
    showTab('Today');
  }
  initAll();
});
</script>
</body>
</html>
